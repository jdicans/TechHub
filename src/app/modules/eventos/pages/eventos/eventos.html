<div class="eventos-container">
  <!-- Header Section -->
  <header class="header">
    <div class="header-content">
      <h1 class="title">Eventos TechHub</h1>
      <p class="subtitle">Descubre y participa en eventos de tecnología de la comunidad</p>
      <div class="header-actions">
        <div class="tabs">
          <button
            class="tab"
            [class.active]="vistaActual === 'todos'"
            (click)="cambiarVista('todos')"
          >
            <lucide-icon name="calendar"></lucide-icon>
            Todos los eventos
          </button>
          <button
            class="tab"
            [class.active]="vistaActual === 'inscritos'"
            (click)="cambiarVista('inscritos')"
          >
            <lucide-icon name="check-circle"></lucide-icon>
            Mis inscripciones
          </button>
        </div>
        <button class="btn-crear" (click)="toggleFormulario()">
          <lucide-icon [name]="mostrarFormulario ? 'x' : 'plus'"></lucide-icon>
          {{ mostrarFormulario ? 'Cancelar' : 'Crear Evento' }}
        </button>
      </div>
    </div>
  </header>

  <!-- Formulario de creación de evento -->
  @if (mostrarFormulario) {
    <div class="formulario-evento card">
      <h2>{{ editandoEvento ? 'Editar Evento' : 'Crear Nuevo Evento' }}</h2>
      <form (ngSubmit)="crearEvento()">
        <div class="form-group">
          <label>Nombre del evento *</label>
          <input type="text" [(ngModel)]="nuevoEvento.nombre" name="nombre" required />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea [(ngModel)]="nuevoEvento.descripcion" name="descripcion" rows="4"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha *</label>
            <input type="date" [(ngModel)]="nuevoEvento.fecha_evento" name="fecha" required />
          </div>
          <div class="form-group">
            <label>Hora</label>
            <input type="time" [(ngModel)]="nuevoEvento.hora_evento" name="hora" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Lugar</label>
            <input type="text" [(ngModel)]="nuevoEvento.lugar" name="lugar" placeholder="Ej: Sala de conferencias" />
          </div>
          <div class="form-group">
            <label>Modalidad</label>
            <select [(ngModel)]="nuevoEvento.modalidad" name="modalidad">
              <option value="presencial">Presencial</option>
              <option value="virtual">Virtual</option>
              <option value="híbrido">Híbrido</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Categoría</label>
          <select [(ngModel)]="nuevoEvento.id_categoria" name="categoria">
            <option [value]="undefined">Sin categoría</option>
            @for (categoria of categoriasDisponibles; track categoria.id_categoria) {
              <option [value]="categoria.id_categoria">{{ categoria.nombre }}</option>
            }
          </select>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            {{ editandoEvento ? 'Actualizar' : 'Crear' }} Evento
          </button>
          <button type="button" class="btn btn-secondary" (click)="toggleFormulario()">Cancelar</button>
        </div>
      </form>
    </div>
  }

  <!-- Filtros -->
  <div class="filtros card" [class.expandido]="filtrosExpandidos">
    <div class="filtros-header" (click)="toggleFiltros()">
      <div class="filtros-header-left">
        <h3>
          <lucide-icon name="filter"></lucide-icon>
          Filtros de búsqueda
        </h3>
        @if (filtrosActivos > 0 && !filtrosExpandidos) {
          <span class="filtros-badge">{{ filtrosActivos }}</span>
        }
      </div>
      <div class="filtros-header-right">
        @if (!filtrosExpandidos && eventosFiltrados.length > 0) {
          <span class="resultados-preview">{{ eventosFiltrados.length }} resultado{{ eventosFiltrados.length !== 1 ? 's' : '' }}</span>
        }
        <button 
          class="btn-toggle" 
          type="button"
          [attr.aria-label]="filtrosExpandidos ? 'Contraer filtros' : 'Expandir filtros'"
        >
          <lucide-icon [name]="filtrosExpandidos ? 'chevron-up' : 'chevron-down'"></lucide-icon>
        </button>
      </div>
    </div>

    <div class="filtros-content" [@slideDown]="filtrosExpandidos ? 'expanded' : 'collapsed'">
    <div class="filtros-grid">
      <!-- Fila 1: Búsqueda y Ordenamiento -->
      <div class="form-group full-width">
        <label>
          <lucide-icon name="search"></lucide-icon>
          Buscar evento
        </label>
        <input
          type="text"
          [(ngModel)]="busqueda"
          placeholder="Buscar por nombre, descripción o lugar..."
        />
      </div>

      <div class="form-group">
        <label>
          <lucide-icon name="arrow-up-down"></lucide-icon>
          Ordenar por
        </label>
        <select [(ngModel)]="ordenamiento">
          <option value="fecha-asc">Fecha (próximos primero)</option>
          <option value="fecha-desc">Fecha (recientes primero)</option>
          <option value="nombre-asc">Nombre (A-Z)</option>
          <option value="nombre-desc">Nombre (Z-A)</option>
          <option value="inscritos-desc">Más inscritos</option>
          <option value="inscritos-asc">Menos inscritos</option>
        </select>
      </div>

      <!-- Fila 2: Filtros específicos -->
      <div class="form-group">
        <label>
          <lucide-icon name="calendar-range"></lucide-icon>
          Período
        </label>
        <select [(ngModel)]="fechaFiltro">
          <option value="">Todas las fechas</option>
          <option value="proximos">Próximos eventos</option>
          <option value="esta-semana">Esta semana</option>
          <option value="este-mes">Este mes</option>
          <option value="pasados">Eventos pasados</option>
        </select>
      </div>

      <div class="form-group">
        <label>
          <lucide-icon name="map-pin"></lucide-icon>
          Modalidad
        </label>
        <select [(ngModel)]="modalidadFiltro">
          <option value="">Todas las modalidades</option>
          <option value="presencial">Presencial</option>
          <option value="virtual">Virtual</option>
          <option value="híbrido">Híbrido</option>
        </select>
      </div>

      <div class="form-group">
        <label>
          <lucide-icon name="check-circle"></lucide-icon>
          Estado
        </label>
        <select [(ngModel)]="estadoFiltro">
          <option value="">Todos los estados</option>
          <option value="disponible">Disponibles</option>
          <option value="finalizado">Finalizados</option>
        </select>
      </div>

      <div class="form-group">
        <label>
          <lucide-icon name="tag"></lucide-icon>
          Categoría
        </label>
        <select [(ngModel)]="categoriaFiltro">
          <option value="">Todas las categorías</option>
          @for (categoria of categoriasDisponibles; track categoria.id_categoria) {
            <option [value]="categoria.id_categoria">{{ categoria.nombre }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Contador de resultados -->
    <div class="filtros-footer">
      <span class="resultados-count">
        <lucide-icon name="list"></lucide-icon>
        {{ eventosFiltrados.length }} evento{{ eventosFiltrados.length !== 1 ? 's' : '' }} encontrado{{ eventosFiltrados.length !== 1 ? 's' : '' }}
      </span>
      <div class="filtros-footer-actions">
        @if (filtrosActivos > 0) {
          <span class="filtros-activos">
            <lucide-icon name="filter"></lucide-icon>
            {{ filtrosActivos }} filtro{{ filtrosActivos !== 1 ? 's' : '' }} activo{{ filtrosActivos !== 1 ? 's' : '' }}
          </span>
        }
        <button class="btn btn-secondary btn-sm" (click)="limpiarFiltros()" type="button">
          <lucide-icon name="x"></lucide-icon>
          Limpiar
        </button>
      </div>
    </div>
    </div>
  </div>

  <!-- Lista de eventos -->
  <div class="eventos-lista">
    @if (cargando) {
      <div class="no-eventos card">
        <lucide-icon name="loader"></lucide-icon>
        <p>Cargando eventos...</p>
      </div>
    } @else if (eventosPaginados.length === 0) {
      <div class="no-eventos card">
        @if (vistaActual === 'todos') {
          <lucide-icon name="calendar"></lucide-icon>
          <h3>No se encontraron eventos</h3>
          <p>Intenta ajustar los filtros de búsqueda para ver más resultados.</p>
        } @else if (vistaActual === 'inscritos') {
          <lucide-icon name="calendar-heart"></lucide-icon>
          <h3>No tienes inscripciones</h3>
          <p>Explora los eventos disponibles y únete a los que más te interesen.</p>
          <button class="btn btn-primary" (click)="cambiarVista('todos')">
            <lucide-icon name="search"></lucide-icon>
            Explorar eventos disponibles
          </button>
        }
      </div>
    } @else {
      <div class="eventos-grid">
        @for (evento of eventosPaginados; track evento.id_evento) {
          <div class="evento-card">
            <div class="evento-contenido">
              <div class="evento-header">
                <h3>{{ evento.nombre }}</h3>
                <div class="badges">
                  @if (evento.modalidad) {
                    <span
                      class="badge"
                      [style.background-color]="getModalidadBadge(evento.modalidad).color === 'primary' ? '#007bff' : getModalidadBadge(evento.modalidad).color === 'success' ? '#28a745' : '#6c757d'"
                    >
                      {{ getModalidadBadge(evento.modalidad).label }}
                    </span>
                  }
                  @if (evento.categoria) {
                    <span class="badge badge-categoria" style="background-color: #6c63ff;">
                      {{ evento.categoria.nombre }}
                    </span>
                  }
                </div>
              </div>

              @if (eventoPasado(evento.fecha_evento)) {
                <div class="alert alert-warning">
                  <lucide-icon name="alert-circle"></lucide-icon>
                  Este evento ya pasó
                </div>
              }

              <p class="evento-descripcion">{{ evento.descripcion || 'Sin descripción' }}</p>

              <div class="evento-detalles">
                <div class="detalle">
                  <lucide-icon name="calendar"></lucide-icon>
                  <span>{{ formatearFecha(evento.fecha_evento) }}</span>
                </div>
                @if (evento.hora_evento) {
                  <div class="detalle">
                    <lucide-icon name="clock"></lucide-icon>
                    <span>{{ evento.hora_evento }}</span>
                  </div>
                }
                @if (evento.lugar) {
                  <div class="detalle">
                    <lucide-icon name="map-pin"></lucide-icon>
                    <span>{{ evento.lugar }}</span>
                  </div>
                }
                @if (evento.organizador) {
                  <div class="detalle">
                    <lucide-icon name="user"></lucide-icon>
                    <span>
                      @if (evento.organizador.nombre) {
                        {{ evento.organizador.nombre }} {{ evento.organizador.apellido }}
                      } @else {
                        Organizador
                      }
                    </span>
                  </div>
                }
              </div>

              @if (evento.inscritos && evento.inscritos.length > 0) {
                <div class="evento-inscritos">
                  <div class="inscritos-info">
                    <lucide-icon name="users"></lucide-icon>
                    <span>{{ evento.total_inscritos || evento.inscritos.length }} inscritos</span>
                  </div>
                </div>
              }

              <div class="evento-acciones">
                @if (esAdmin()) {
                  <!-- Botones de admin (editar/eliminar cualquier evento) -->
                  <button class="btn btn-secondary" (click)="editarEvento(evento)">
                    <lucide-icon name="edit-2"></lucide-icon>
                    Editar
                  </button>
                  <button class="btn btn-danger" (click)="eliminarEvento(evento.id_evento!)">
                    <lucide-icon name="trash-2"></lucide-icon>
                    Eliminar
                  </button>
                } @else if (!eventoPasado(evento.fecha_evento)) {
                  <!-- Botones de inscripción -->
                  @if (evento.esta_inscrito) {
                    <button class="btn btn-success" (click)="desinscribirse(evento.id_evento!)">
                      <lucide-icon name="check"></lucide-icon>
                      Inscrito
                    </button>
                  } @else {
                    <button class="btn btn-primary" (click)="inscribirse(evento.id_evento!)">
                      <lucide-icon name="plus"></lucide-icon>
                      Inscribirse
                    </button>
                  }
                }
              </div>
            </div>
          </div>
        }
      </div>

        <!-- Paginación -->
        <app-pagination
          [currentPage]="paginaActual"
          [totalItems]="totalItems"
          [itemsPerPage]="itemsPorPagina"
          [maxVisiblePages]="5"
          (pageChange)="onPaginaChange($event)"
        ></app-pagination>
      }
  </div>
</div>
